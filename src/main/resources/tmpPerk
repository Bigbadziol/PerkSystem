package badziol.perksystem.perk.GlebokieRany;

import badziol.perksystem.PerkSystem;
import badziol.perksystem.perk.Perk;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityDamageByEntityEvent;

import java.util.HashMap;
import java.util.UUID;

public class PerkGlembokieRany extends Perk implements Listener {
    private PerkGlebokieRanyData pgd = new PerkGlebokieRanyData(0d,0l);
    public final HashMap<UUID, PerkGlebokieRanyData> ranni = new HashMap<>();

    public PerkGlembokieRany(PerkSystem plugin) {
        super(plugin);
        nazwaId = "glembokieciecie";
        wyswietlanie = "Głębokie cięcie";
        opis.add("Dość nie etyczna zabawa ta,");
        opis.add("ludzi wykrwawiasz kożdego dnia");
        opis.add("");
        opis.add("Twoji przeciwnicy wykrwawiają sie prez 2s");
        opis.add("o 30% zadanych obrażeń. Jedynie kiedy");
        opis.add("zostały zadane crytikalsem");
        textura = "eyJ0ZXh0dXJlcyI6eyJTS0lOIjp7InVybCI6Imh0dHA6Ly90ZXh0dXJlcy5taW5lY3J" +
                "ZnQubmV0L3RleHR1cmUvOTNhMzk2MGM4Nzk0NzQwMTdjMGNhM2M4MGY2ZWU3M2NmODg2ZTAwZTg5" +
                "YzkwMmEzZWU4OTNkZDI4NDk1MzVjMCJ9fX0=";
        inicjujGlowke();
    }

    /**
     * Na podstawie uuid pobierz rannego (wykrwawiajacego sie gracza)
     * @param uuid
     * @return obiekt gracza lub null
     */
    public PerkGlebokieRanyData pobierzRannego(UUID uuid) {
        return ranni.get(uuid);
    }


    @EventHandler
    public void onGlebokiCios(EntityDamageByEntityEvent event) {
        if (event.getEntity() instanceof Player) {
            double finalDamage = event.getFinalDamage();
            Player ofiara = (Player) event.getEntity();

            if (event.getDamager() instanceof Player) {
                Player atakujacy = (Player) event.getDamager();
                if (plugin.perkLista.czyPosiadaAktywny(atakujacy.getName(), nazwaId)) {
                    aktywuj(ofiara,finalDamage,System.currentTimeMillis());

                }
            }
        }
    }

    public  void aktywuj(Player gracz, double lastHit, long czas){
        pgd = pobierzRannego(gracz.getUniqueId());
        if (pgd == null){
            ranni.put(gracz.getUniqueId(), new PerkGlebokieRanyData(lastHit,czas));//-----------------------------
            pgd = ranni.get(gracz.getUniqueId());
            System.out.println("[GlebokieRany] - dodano nowego rannego.");
            System.out.println("----wykrwawiacz start---");
            System.out.println("Bazowy cios :"+ pgd.bazoweObrazenie);
            System.out.println("Krwawienie wartosc :"+(pgd.bazoweObrazenie * pgd.procetObrazen));
            System.out.println("obrazenia per tick : "+ pgd.tickObrazenie);
            ranni.put( gracz.getUniqueId(), pgd);
            System.out.println("Rozmiar 1:"+ ranni.size());
        }else {
            System.out.println("[GlebokieRany] - gracz juz krwawi.");
            System.out.println("Rozmiar 2:"+ ranni.size());
        }
    }
/*
    @Override
    public void aktywuj(Player gracz) {
  //      pgd = pobierzRannego(gracz.getUniqueId());
        System.out.println("[AKTYWACJA](GlebokieRany) - puste wywolanie.");
    }

    @Override
    public void  dezaktywuj(Player gracz){
 //       pgd = pobierzRannego(gracz.getUniqueId());
        System.out.println("[DEAKTYWACJA](GlebokieRany) - puste wywolanie.");

    }

 */
}


